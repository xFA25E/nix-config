#!/bin/sh

MUSIC_DIRECTORY="${XDG_MUSIC_DIR:-${HOME}/Music}"

[ -d "${MUSIC_DIRECTORY}" ] || exit 1

select_directory() {
    find "${MUSIC_DIRECTORY}" -type d ! -wholename "${MUSIC_DIRECTORY}" \
        | cut -c "$((${#MUSIC_DIRECTORY} + 2))-" \
        | sort \
        | rofi -dmenu -p "Select directory" -select "0unsorted" -i
}

selected_dir="$(select_directory)"

output="${MUSIC_DIRECTORY}/${selected_dir}/%(title)s.%(ext)s"
args="--audio-format mp3 --embed-thumbnail"

if [ "$(printf 'no\nyes' | rofi -dmenu -p 'Playlist?' -select no)" = yes ]; then
    output="${MUSIC_DIRECTORY}/${selected_dir}/%(playlist)s/%(playlist_index)s - %(title)s.%(ext)s"
    args="${args} --yes-playlist"
fi

exec ytdla --output "${output}" ${args} "$@"
