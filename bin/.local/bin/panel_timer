#!/bin/sh

name="${1:?provide name}"
elapsed="${2:?provide remain}"
duration="${3:?provide duration}"
state="${4:?provide state}"
max_duration="$(echo '(2 ^ 64) - 1' | bc)"

format_secs() {
    if [ "${1:?provide seconds}" -lt 60 ]; then
        echo "${1}s"
    else
        minutes="$((${1} / 60))"
        if [ "${minutes}" -lt 60 ]; then
            echo "${minutes}m"
        else
            echo "$((minutes / 60))h $((minutes % 60))m"
        fi
    fi
}

save_log() {
    date "+%Y %m %d ${1:?provide activity} ${2:?provide duration}" >> "${3:?provide file}"
}

case "${state}" in
    running|paused)
        if [ "${duration}" = "${max_duration}" ]; then
            time="$(format_secs "${elapsed}")"
        else
            time="$(format_secs "$((duration - elapsed))")/$(format_secs "${duration}")"
        fi
        runel remote set timer "${name} ${time} ${state}"
    ;;
    halted)
        runel remote set timer "off"
        notify-send "Timer" "\"${name}\" finished"

        if [ "${name}" = eyes ]; then
            notify_sound "${HOME}/Music/solemn_notification.ogg"
        else
            notify_sound
        fi

        case "${name}" in
            study)
                mark_file="${HOME}/org/${name}.marks"
                log_file="${HOME}/org/${name}.log"
                selected="$(tail -n 1 "${log_file}" | cut -d" " -f4)"
                what="$(awk '!$3 && $1 {print $1}' "${mark_file}" | rofi -dmenu -p "What" -select "${selected}")"
                save_log "${what:?}" "${elapsed}" "${log_file}"

                pause="$(printf "yes\nno" | rofi -dmenu -p "Pause?")"
                if [ "${pause}" = yes ]; then
                    rimer add --name pause --duration $((60 * 5))
                fi
                ;;
            eyes)
                again="$(printf "yes\nno" | rofi -dmenu -p "Again ${name}?")"
                if [ "${again}" = yes ]; then
                    rimer add --name "${name}" --duration "${duration}"
                fi
        esac
        ;;
esac
